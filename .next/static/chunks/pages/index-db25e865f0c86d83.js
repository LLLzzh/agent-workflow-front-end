(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[332],{2022:(e,t,a)=>{(window.__NEXT_P=window.__NEXT_P||[]).push(["/",function(){return a(2049)}])},2049:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>P});var s=a(4848),l=a(6540);let n=a(4335).A.create({baseURL:"http://127.0.0.1:5000",timeout:5e3});async function r(e){return(await n.post("/agent/create",e)).data}async function d(e){return await n.post("/agent/update",e)}async function i(e){return await n.get("/agent/delete?id=".concat(e))}async function o(e){return(await n.get("/agent/list?kind=".concat(e))).data}async function c(e){let t=await fetch("http://127.0.0.1:5000/call/one",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.body)throw Error("Response body is empty");return t}let u=async(e,t)=>{try{return(await n.post(e,t)).data}catch(e){throw console.error(e),e}},m=async e=>await u("/scene/create",e),b=async e=>await u("/scene/update",e),x=async e=>await u("/scene/delete",e),p=async e=>await u("/scene/list",e);function h(e){let{formData:t,setFormData:a}=e;return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)("div",{className:"mb-4",children:[(0,s.jsx)("label",{className:"block mb-2",children:"身份设置"}),(0,s.jsx)("input",{type:"text",value:t.identity_setting||"",onChange:e=>a({...t,identity_setting:e.target.value}),className:"w-full p-2 border rounded"})]}),(0,s.jsxs)("div",{className:"mb-4",children:[(0,s.jsx)("label",{className:"block mb-2",children:"任务"}),(0,s.jsx)("textarea",{value:t.task||"",onChange:e=>a({...t,task:e.target.value}),className:"w-full p-2 border rounded h-40 "})]})]})}function g(e){let{formData:t,setFormData:a}=e;return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)("div",{className:"mb-4",children:[(0,s.jsx)("label",{className:"block mb-2",children:"身份设置"}),(0,s.jsx)("input",{type:"text",value:t.identity_setting||"",onChange:e=>a({...t,identity_setting:e.target.value}),className:"w-full p-2 border rounded"})]}),(0,s.jsxs)("div",{className:"mb-4",children:[(0,s.jsx)("label",{className:"block mb-2",children:"任务"}),(0,s.jsx)("input",{type:"text",value:t.task||"",onChange:e=>a({...t,task:e.target.value}),className:"w-full p-2 border rounded"})]}),(0,s.jsxs)("div",{className:"mb-4",children:[(0,s.jsx)("label",{className:"block mb-2",children:"输出"}),(0,s.jsx)("input",{type:"text",value:t.output||"",onChange:e=>a({...t,output:e.target.value.split(",")}),className:"w-full p-2 border rounded"})]})]})}var y=a(8553);function f(e){let{formData:t,setFormData:a}=e;return(0,s.jsx)("div",{children:(0,s.jsxs)("div",{className:"mb-4",children:[(0,s.jsx)("label",{className:"block mb-2",children:"代码块"}),(0,s.jsx)("div",{className:"relative",children:(0,s.jsx)(y.KE,{className:"w-full pt-2",height:"350px",language:"python",theme:"vs-dark",value:t.deal||"",onChange:e=>{a({...t,deal:e||""})},options:{selectOnLineNumbers:!0,minimap:{enabled:!1},fontSize:16}})})]})})}function j(e){let{formData:t,setFormData:a}=e;return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)("div",{className:"mb-4",children:[(0,s.jsx)("label",{className:"block mb-2",children:"身份设置"}),(0,s.jsx)("input",{type:"text",value:t.identity_setting||"",onChange:e=>a({...t,identity_setting:e.target.value}),className:"w-full p-2 border rounded"})]}),(0,s.jsxs)("div",{className:"mb-4",children:[(0,s.jsx)("label",{className:"block mb-2",children:"风格"}),(0,s.jsx)("input",{type:"text",value:t.style||"",onChange:e=>a({...t,style:e.target.value}),className:"w-full p-2 border rounded"})]})]})}var v=a(4919),N=a(23);let k=e=>{let{workflowAgents:t,currentOutput:a}=e,[n,r]=(0,l.useState)({});(0,l.useEffect)(()=>{let e={...n};a.forEach(t=>{e[t.id]!==t.content&&(e[t.id]=t.content)}),r(e)},[a]);let d=e=>({__html:(0,N.xI)(e)});return(0,s.jsxs)("div",{className:"w-1/3 border-r max-h-full overflow-y-auto",children:[(0,s.jsx)("div",{className:"text-xl font-bold -mb-1 p-4 pt-5 pl-6 pb-3 sticky border-b-2 top-0 bg-gray-100",children:"输出"}),(0,s.jsx)("div",{className:"space-y-4 p-4",children:t.length>0?t.map((e,t)=>(0,s.jsxs)("div",{className:"p-2 border-0 rounded-md",children:[(0,s.jsx)("div",{className:"font-semibold mb-3 rounded p-3 bg-gray-100",children:"Step ".concat(t+1,": ").concat(e.name)}),void 0!==n[e.id]?(0,s.jsx)("div",{className:"markdown-output p-4 border",dangerouslySetInnerHTML:d(n[e.id])}):(0,s.jsx)("p",{children:"未执行"})]},e.id)):(0,s.jsx)("p",{className:"text-gray-500",children:"没有待执行的步骤。"})})]})};var w=a(1133),C=a(8546);function S(e){let{data:t,deleteNode:a}=e,[n,r]=(0,l.useState)(!1);return(0,s.jsxs)("div",{className:"bg-white max-h-18 w-60 py-3 rounded flex justify-center items-center  ".concat(n?"border-black":"shadow-gray-300"),onMouseMoveCapture:()=>{r(!0)},onMouseOutCapture:()=>{r(!1)},children:["1"===t.id||(0,s.jsx)(w.h7,{type:"target",position:C.yX.Left}),(0,s.jsxs)("label",{className:"flex relative items-center font-bold h-8 mr-auto ml-6",children:[JSON.stringify(t.label).replace(/^["']|["']$/g,""),"1"===t.id||(0,s.jsx)("button",{onClick:()=>{console.log("delete node",t.id),a(t.id)},className:"ml-auto mr-2 h-8 w-8 ".concat(n?"block":"hidden"),children:"❌"})]}),(0,s.jsx)(w.h7,{type:"source",position:C.yX.Right})]})}function _(){let[e,t]=(0,l.useState)([]),[a,n]=(0,l.useState)(""),[r,d]=(0,l.useState)(""),[i,o]=(0,l.useState)([{id:"",content:""}]),[u,h]=(0,l.useState)(!1),[g,y]=(0,l.useState)("未命名"),[f,j]=(0,l.useState)(!1),[N,_]=(0,l.useState)([]),[E,D]=(0,l.useState)(!1),[A,F]=(0,l.useState)(null),O=[{id:"1",data:{label:"\uD83D\uDD25  start",id:"1"},position:{x:0,y:0},sourcePosition:"right",type:"deletableNode",style:{border:"3px solid #1e2022"}}],T=[],[P,M]=(0,w.ck)(O),[G,z]=(0,w.fM)(T),H=(0,l.useCallback)(e=>M(t=>(0,w._0)(e,t)),[M]),J=(0,l.useCallback)(e=>z(t=>(0,w.zW)(e,t)),[z]),L=(0,l.useCallback)(e=>{z(t=>(0,C.rN)(e,t))},[z]),R=e=>{M(t=>t.filter(t=>t.id!==e)),z(t=>t.filter(t=>t.source!==e&&t.target!==e)),F(null)},W=(0,l.useMemo)(()=>({deletableNode:e=>(0,s.jsx)(S,{...e,deleteNode:R})}),[R]),X=(0,l.useCallback)((e,t)=>{F(t)},[]),I=["\uD83D\uDCAC","\uD83D\uDCC8","\uD83D\uDCBB","\uD83C\uDFA8"],U=(0,l.useRef)([]),[{isOver:Z},B]=(0,v.H)(()=>({accept:"AGENT",drop:(e,t)=>{let a=t.getClientOffset();a&&(U.current=[...U.current,e],M(t=>[...t,{id:e.id,data:{label:I[e.kind]+e.name,id:e.id},position:{x:a.x-600,y:a.y-200},type:"deletableNode"}]))},collect:e=>({isOver:e.isOver()})})),K=async()=>{var e;let t=null===(e=(await p({page:1,pageSize:10})).payload)||void 0===e?void 0:e.scenes;_(t),console.log(t)};(0,l.useEffect)(()=>{K()},[]);let V=e=>{let t=N.find(t=>t.id===e);t&&(h(!0),y(t.name),$(t.agents))},$=e=>{z(T),M(O),U.current=[],M([{id:"start",data:{label:"\uD83D\uDD25  start",id:"1"},position:{x:0,y:0},type:"deletableNode",style:{border:"3px solid #1e2022"}},...e.map((e,t)=>(U.current=[...U.current,e],{id:e.id,data:{label:I[e.kind]+e.name,id:e.id},position:{x:(t+1)*300,y:t%2==1?0:100},type:"deletableNode"}))]);let t=e.slice(1).map((t,a)=>({id:"e".concat(e[a].id,"-").concat(t.id),source:e[a].id,target:t.id,markerEnd:{type:C.TG.ArrowClosed},animated:!0,style:{stroke:"#1e2022",strokeWidth:2}}));z([{id:"e_start-".concat(e[0].id),source:"start",target:e[0].id,markerEnd:{type:C.TG.ArrowClosed},animated:!0,style:{stroke:"#1e2022",strokeWidth:2}},...t])},q=async()=>{console.log(e);let t={name:g,agents:e.map(e=>e.id)},a=await m(t);0==a.code&&(h(!0),console.log("create scene success",a)),await K()},Q=async()=>{var e;let t=null===(e=N.find(e=>e.name===g))||void 0===e?void 0:e.id;if(!t)return;console.log(t);let a=await x({id:t});if((null==a?void 0:a.code)==0){console.log("delete scene success",a),window.location.reload();return}console.error(a)};(0,l.useEffect)(()=>{t(et(G).map(e=>U.current.find(t=>t.id===e)).filter(e=>e))},[G]);let Y=async()=>{let t=a,s="";for(let a=0;a<e.length;a++){let l=e[a],n=await ee(l,t);s+=n.content,t=n.content,o(e=>[...e,{id:l.id,content:n.content}])}d(s)},ee=async(e,t)=>{var a;let s=null===(a=(await c({id:e.id,kind:e.kind,input:t})).body)||void 0===a?void 0:a.getReader(),l=new TextDecoder("utf-8"),n="",r=!1;for(;!r;){let{value:t,done:a}=await s.read();for(let s of(r=a,l.decode(t,{stream:!0}).split("\n").filter(e=>e.trim())))try{let t=JSON.parse(s);t.content&&(n+=t.content,o([{id:e.id,content:n}]))}catch(e){console.error("Failed to parse line:",s,e)}}return{content:n}},et=e=>{let t={},a=new Set;return e.forEach(e=>{let{source:s,target:l}=e;t[s]||(t[s]=[]),t[s].push(l),a.add(s),a.add(l)}),(()=>{let e=new Set,s=[],l=a=>{e.has(a)||(e.add(a),t[a]&&t[a].forEach(l),s.push(a))};return a.forEach(l),s.reverse()})()},ea=G.map(e=>({...e,markerEnd:{type:C.TG.ArrowClosed,width:15,height:15,color:"#1e2022"},animated:!0,style:{stroke:"#1e2022",strokeWidth:2}})),es=P.map(e=>({...e,style:{border:"none"},sourcePosition:"right",targetPosition:"left"}));return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(k,{workflowAgents:e,currentOutput:i}),(0,s.jsxs)("div",{ref:B,className:"flex flex-col p-4 w-2/3",children:[(0,s.jsxs)("div",{className:"mb-4 flex justify-between pl-4 pr-4 pt-4",children:[(0,s.jsxs)("div",{className:"flex",children:[(0,s.jsx)("h2",{className:"text-xl font-bold",children:"我的工作流"}),(0,s.jsx)("h2",{className:"text-xl font-bold ml-4",onClick:()=>{j(!0)},children:f?(0,s.jsx)("input",{type:"text",value:g,onChange:e=>{y(e.target.value)},onBlur:()=>{j(!1)},className:"border-b-2"}):g})]}),(0,s.jsxs)("div",{className:"flex",children:[u&&(0,s.jsx)("button",{onClick:Q,className:"px-4 py-2 bg-gray-200 border border-gray-300 ml-4 text-black rounded",children:"删除场景"}),(0,s.jsxs)("div",{className:"relative",children:[(0,s.jsx)("button",{className:"px-4 py-2 bg-gray-200 border border-gray-300 text-black rounded w-30 ml-4",onClick:()=>D(!E),children:"选择场景"}),E&&(0,s.jsx)("div",{className:"absolute px-0 py-2 left-0 mt-2 bg-white rounded z-50 w-34",onMouseLeave:()=>D(!1),children:N.map(e=>(0,s.jsx)("div",{onClick:()=>V(e.id),className:"px-4 py-2 hover:bg-gray-100 cursor-pointer z-20",children:e.name},e.id))})]}),u?(0,s.jsx)("button",{onClick:()=>{console.log(e);let t=b({name:g,agents:e.map(e=>e.id)});(null==t?void 0:t.code)==0&&console.log("update scene success",t)},className:"px-4 py-2 bg-gray-200 border border-gray-300 ml-4 text-black rounded",children:"保存场景"}):(0,s.jsx)("button",{onClick:q,className:"px-4 py-2 bg-gray-200 border border-gray-300 ml-4 text-black rounded",children:"创建场景"})]})]}),(0,s.jsx)("div",{className:"w-full h-96 pl-4 pr-4 rounded ",children:(0,s.jsxs)(w.Gc,{className:"relative",nodes:es,nodeTypes:W,edges:ea,onNodesChange:H,onEdgesChange:J,onNodeClick:X,onConnect:L,minZoom:.5,maxZoom:2,children:[(0,s.jsx)(w.VS,{bgColor:"#f9f9f9",gap:16,className:"rounded"}),(0,s.jsx)(w.H2,{})]})}),(0,s.jsxs)("div",{className:"mb-4 pr-4 pl-4 mt-4 ",children:[(0,s.jsxs)("div",{className:"flex justify-between relative",children:[(0,s.jsx)("div",{className:"font-bold mb-3 p-2  w-1/4 pl-6 border-b-2 rounded bg-gray-100",children:"输入"}),(0,s.jsx)("button",{onClick:Y,className:"absolute right-0 px-4 py-2 mb-2 bg-green-600 text-white rounded ml-4",children:"执行工作流"})]}),(0,s.jsx)("textarea",{value:a,onChange:e=>n(e.target.value),className:"w-full p-2 border-gray-300 border rounded h-60 bg-white "})]})]})]})}a(9703);var E=a(9216);function D(e){let{onAgentAdd:t}=e,[a,n]=(0,l.useState)([]),[c,u]=(0,l.useState)(!1),[m,b]=(0,l.useState)(null),x=async()=>{let e=[];for(let t=0;t<4;t++){let a=await o(t);a.payload&&e.push(...a.payload)}n(e)};(0,l.useEffect)(()=>{x()},[]);let p=a.reduce((e,t)=>(e[t.kind]||(e[t.kind]=[]),e[t.kind].push(t),e),{});return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(_,{agents:a}),(0,s.jsxs)("div",{className:"w-1/4  border-l pl-6 pr-4  overflow-y-auto relative   ",children:[(0,s.jsxs)("div",{className:"flex justify-between items-center -ml-6 mb-4 pt-5 sticky top-0 pb-3 pl-6 -mr-4  bg-gray-100 border-b-2 px-4",children:[(0,s.jsx)("div",{className:"text-xl font-bold  sticky top-0 w-full h-15",children:"Agent列表"}),(0,s.jsx)("button",{onClick:()=>u(!0),className:"text-2xl bg-black border border-gray-300 ml-4 px-3 text-white rounded ",children:"+"})]}),Object.entries(p).map(e=>{let[t,a]=e;return(0,s.jsx)(A,{kind:parseInt(t),agents:a,onEditAgent:e=>b(e)},t)}),c&&(0,s.jsx)(O,{onClose:()=>u(!1),onAdd:async e=>{let s=await r(e),l={...e,id:s.payload};n([...a,l]),t(l),u(!1)}}),m&&(0,s.jsx)(T,{agent:m,onClose:()=>b(null),onDelete:async e=>{await i(e.id),await x(),b(null)},onUpdate:async e=>{await d({...e}),await x(),t(e),b(null)}})]})]})}function A(e){let{kind:t,agents:a,onEditAgent:n}=e,[r,d]=(0,l.useState)(!0);return(0,s.jsxs)("div",{className:"mb-4",children:[(0,s.jsxs)("button",{onClick:()=>d(!r),className:"w-full text-left font-bold p-2 bg-gray-100",children:[["Analyser","Judge","Handler","Painter"][t]," (",a.length,")"]}),r&&(0,s.jsx)("div",{className:"space-y-2 mt-2",children:a.map(e=>(0,s.jsx)(F,{agent:e,onEdit:()=>n(e)},e.id))})]})}function F(e){let{agent:t,onEdit:a}=e,[{isDragging:l},n]=(0,E.i)(()=>({type:"AGENT",item:{...t},collect:e=>({isDragging:e.isDragging()})}));return(0,s.jsxs)("div",{ref:n,className:"p-4 border rounded ".concat(l?"opacity-50":""),onClick:a,children:[(0,s.jsx)("h3",{className:"font-bold",children:["\uD83D\uDCAC","\uD83D\uDCC8","\uD83D\uDCBB","\uD83C\uDFA8"][t.kind]+t.name}),(0,s.jsx)("p",{className:"text-sm overflow-hidden max-w-full",children:t.description})]})}function O(e){let{onClose:t,onAdd:a}=e,[n,r]=(0,l.useState)({kind:0}),[d,i]=(0,l.useState)({kind:n.kind,name:"",description:"",avatar:""});return(0,l.useEffect)(()=>{switch(n.kind){case 0:i({...d,kind:0,identity_setting:"",task:""});break;case 1:i({...d,kind:1,identity_setting:"",task:"",output:[]});break;case 2:i({...d,kind:2,identity_setting:"",task:""});break;case 3:i({...d,kind:3,identity_setting:"",style:""})}},[n.kind]),(0,s.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center",children:(0,s.jsx)("div",{className:"bg-white p-4 rounded max-w-md w-full",children:(0,s.jsxs)("div",{children:[(0,s.jsxs)("div",{className:"mb-4",children:[(0,s.jsx)("label",{className:"block mb-2",children:"类型"}),(0,s.jsx)("select",{value:n.kind,onChange:e=>{let t=Number(e.target.value);r({kind:t}),i({...d,kind:t})},className:"w-full p-2 border rounded",children:[{value:0,label:"Analyser"},{value:1,label:"Judge"},{value:2,label:"Handler"},{value:3,label:"Painter"}].map(e=>(0,s.jsx)("option",{value:e.value,children:e.label},e.value))})]}),(0,s.jsxs)("div",{className:"mb-4",children:[(0,s.jsx)("label",{className:"block mb-2",children:"名称"}),(0,s.jsx)("input",{type:"text",value:d.name||"",onChange:e=>i({...d,name:e.target.value}),className:"w-full p-2 border rounded"})]}),(0,s.jsxs)("div",{className:"mb-4",children:[(0,s.jsx)("label",{className:"block mb-2",children:"描述"}),(0,s.jsx)("input",{type:"text",value:d.description||"",onChange:e=>i({...d,description:e.target.value}),className:"w-full p-2 border rounded"})]}),(()=>{switch(d.kind){case 0:return(0,s.jsx)(h,{formData:d,setFormData:i});case 1:return(0,s.jsx)(g,{formData:d,setFormData:i});case 2:return(0,s.jsx)(f,{formData:d,setFormData:i});case 3:return(0,s.jsx)(j,{formData:d,setFormData:i});default:return null}})(),(0,s.jsxs)("div",{className:"flex justify-end gap-2",children:[(0,s.jsx)("button",{type:"button",onClick:t,className:"px-4 py-2 border rounded",children:"取消"}),(0,s.jsx)("button",{onClick:()=>a(d),className:"px-4 py-2 bg-blue-500 text-white rounded",children:"添加"})]})]})})})}function T(e){let{agent:t,onClose:a,onUpdate:n,onDelete:r}=e,[d,i]=(0,l.useState)({...t});return(0,s.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center",children:(0,s.jsx)("div",{className:"bg-white p-4 rounded max-w-md w-full",children:(0,s.jsxs)("div",{children:[(0,s.jsxs)("div",{className:"mb-4",children:[(0,s.jsx)("label",{className:"block mb-2",children:"名称"}),(0,s.jsx)("input",{type:"text",value:d.name||"",onChange:e=>i({...d,name:e.target.value}),className:"w-full p-2 border rounded"})]}),(0,s.jsxs)("div",{className:"mb-4",children:[(0,s.jsx)("label",{className:"block mb-2",children:"描述"}),(0,s.jsx)("input",{type:"text",value:d.description||"",onChange:e=>i({...d,description:e.target.value}),className:"w-full p-2 border rounded"})]}),(()=>{switch(d.kind){case 0:return(0,s.jsx)(h,{formData:d,setFormData:i});case 1:return(0,s.jsx)(g,{formData:d,setFormData:i});case 2:return(0,s.jsx)(f,{formData:d,setFormData:i});case 3:return(0,s.jsx)(j,{formData:d,setFormData:i});default:return null}})(),(0,s.jsxs)("div",{className:"flex justify-end gap-2",children:[(0,s.jsx)("button",{type:"button",onClick:()=>r(d),className:"px-4 py-2 border-red-500 text-red-500 rounded",children:"删除"}),(0,s.jsx)("button",{type:"button",onClick:a,className:"px-4 py-2 border rounded",children:"取消"}),(0,s.jsx)("button",{onClick:()=>n(d),className:"px-4 py-2 bg-blue-500 text-white rounded",children:"保存"})]})]})})})}function P(){let[e,t]=(0,l.useState)([]),[a,n]=(0,l.useState)([]);return(0,s.jsx)("div",{className:"flex h-screen",children:(0,s.jsx)(D,{onAgentAdd:e=>{}})})}}},e=>{var t=t=>e(e.s=t);e.O(0,[845,814,636,593,792],()=>t(2022)),_N_E=e.O()}]);